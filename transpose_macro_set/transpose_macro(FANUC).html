<h1>transpose_macro(FANUC).pl について</h1>

<h3>[使用用途]</h3>
<p>マクロ呼び出し命令、サブプログラム呼び出し命令を含むNCデータを、
それらが実行された状態に置換して、一つのプログラムにします。<br>
また、マクロ文を平易なNC文に変換(実機の内部変換をシミュレート)します。
ちなみに、FANUC用です。</p>

<h3>[使用方法]</h3>
<p>まずはPerlが動作する環境を作ってください。詳細は<a href="http://s-gikan2.maizuru-ct.ac.jp/f-board/forum.php?FID=3">こちら</a>の「ActivePerl のインストール方法」のスレッドを参照してください。<br>
また、簡単に使用するには、Scriptoriumというソフトウェアを別途用意してください。<a href="http://s-gikan2.maizuru-ct.ac.jp/script/index.html">こちら</a>から入手できます。<br>
Scriptoriumを開いて、スクリプトファイルにtranspose_macro.pl、
入力ファイルに呼び出し命令を含むNCコードが入っているファイル、
出力ファイルに出力したいファイルパスを指定して実行します。</p>

<h3>[変換されるものについて]</h3>
・マクロ呼び出し命令G65,G66,サブプログラム呼び出し命令M98<br>
・変数の代入式(=を含むブロック)<br>
・マクロの変数<br>
・四則演算(+-*/)<br>
・関数SIN,COS,TAN,ATAN,ABS,SQRT,ROUND,FIX,FUP<br>
・関数AND,OR,XOR,BCD,BIN<br>
・IF,WHILE,DO構文<br>
・条件式EQ,NE,GT,LT,GE,LE<br>
・GOTO文</p>

<h3>[呼び出されるプログラムについて]</h3>
<p>呼び出し命令から呼び出されるプログラムは</p>
<p><b>1.</b> 入力ファイル(変換されるファイル)の中に
   O<呼び出されるプログラム番号>
   で始まる行があれば、それ以降の行が読み込まれます。</p>
<p><b>2.</b> 入力ファイル以外からの呼び出し命令の場合（呼び出されたプログラムが
   入力ファイル以外のファイルに入っていて、その中に更に呼び出し命令がある場合）、
   1.で見つからなければ、呼び出し命令が入っているファイルの中に
   O<呼び出されるプログラム番号>
   で始まる行があれば、それ以降の行が読み込まれます。</p>
<p><b>3.</b> 1.,2.で該当するものがなければ、入力ファイルと同じ階層(フォルダ)の中のファイルを検索します。</br></p>

<p><u>検索されるマクロプログラム、サブプログラムのファイル名について</u><br>
呼び出されるマクロプログラム、サブプログラムのファイルは、
ファイル名を O<プログラム番号>.ncd としてください。
プログラム番号の前の0は、付けても付けなくても構いません。
(例えば、プログラム番号10のファイル名は O10.ncd　または　O0010.ncd)
また、O<プログラム番号>の後に( )が入っていても認識します
(ファイル名を O10(bolt_hole_circle).ncd としても認識する)。<br></p>

<p><b>4.</b> 3.でファイルが見つからなければ、下記で登録するフォルダの中のファイルを検索します。<br>
ファイル名のルールは3.と同じです。</p>

<p><u>マクロプログラム、サブプログラム用のフォルダ(兼用)の登録について</u><br>
スクリプト中の<br>
<b>$macro_folder= 'C:\Program Files\NCVC\macro';</b><br>
の行でマクロプログラム、サブプログラム用のフォルダ(兼用)のパスを登録してください。<br>
デフォルトでは上記のようになっているので、変更したい場合は、'　'で囲まれた部分を変更してください。<br>
それから、フォルダ名の最後に\はつけないでください。</p>
よく使うプログラムのファイルはここで登録したフォルダに置くと便利かと思われます。</p>

<p><b>5.</b> 4.でもファイルが見つからなければ、マクロ呼び出し命令をそのまま出力します。</p>

<h3>[システム変数について]</h3>
<p><b>・#3000</b><br>
#3000= (アラーム番号);<br>
のブロックを通るとメッセージとともに終了します。</p>
<p><b>・#4001〜#4120</b><br>
通ったブロックのモーダル情報が自動的に入ります。</p>
<p>・#4001〜4022: Gコード各グループのモーダル情報<br>
・#4102: Bコード<br>
・#4109: Fコード<br>
・#4111: Hコード<br>
・#4113: Mコード<br>
・#4119: Sコード<br>
・#4120: Tコード</p>

また、Gコードのモーダル情報(#4001〜#4022)の初期値には、FANUCのマニュアルに書いてある電源投入時のものが入ります。
（初期値がマニュアルにないグループには値は入りません。）<br></p>
<p>・#4001(グループ1): 0<br>
・#4002(グループ2): 17<br>
・#4003(グループ3): 90<br>
・#4004(グループ4): 22<br>
・#4005(グループ5): 94<br>
・#4007(グループ7): 40<br>
・#4008(グループ8): 49<br>
・#4009(グループ9): 80<br>
・#4010(グループ10): 98<br>
・#4011(グループ11): 50<br>
・#4012(グループ12): 67<br>
・#4013(グループ13): 97<br>
・#4014(グループ14): 54<br>
・#4015(グループ15): 64<br>
・#4016(グループ16): 69<br>
・#4017(グループ17): 15<br>
・#4018(グループ18): 50.1<br>
・#4019(グループ19): 40.1<br>
・#4020(グループ20): 160<br></p>
もし、お使いの機械が違う設定なら下記のものと同じ要領で登録してください。</p>

<p><b>・その他のシステム変数</b><br>
その他のシステム変数を使用する場合で、初期値が必要なものは値を登録してください。
初期状態のGコードのモーダル情報が違う場合も同様。<br>
スクリプト中の<br>
<b>#%system_value= (,);</b><br>
の行の行頭の#を削除して、<br>
<b>%system_value= (変数番号,変数値);</b><br>
としてください。<br>
登録する変数が複数ある場合は,で区切って変数番号,その値を順番に羅列してください。<br>
<b>%system_value= (変数番号1,変数1の値,変数番号2,変数2の値,・・・);</b><br>
<br>
例えば#4119に3000、#4120に1を登録したいときは<br>
<b>%system_value= (4119,3000,4120,1);</b><br>
となります。</p>

<p><h3>[コメント出力について]</h3>
オプションで変換前の原文等をコメント出力できます。<br>
<br>
変換前の原文は(^^ と ^^)で、内部処理は(---と---)でくくられて出力されます。<br>
ここで、変換前の原文とは呼び出し命令のブロック、マクロに関するブロックを指し、<br>
内部処理とは変数に値が代入されたとき、EQ、NE等の条件の判定が行われたとき等のことを指します。<br>
NC文がどのように動いているか確かめたい場合に出力させてください。<br>
<br>
また、#4000番台にはモーダル情報が自動で入りますが、入った値は(----と----)でくくられて出力されます。<br>
モーダル情報を使わない場合は不必要なので、オプションを別にしました。<br>
<br>
どちらもデフォルトでは出力されないので、スクリプト内で設定してください。<br>
<br>
<b>・変換前の原文及び、内部処理のコメント出力の設定</b><br>
スクリプト内の<br>
<b>$debug_flag= 0;</b><br>
の行で、出力する場合は1、しない場合は0に設定してください。<br>
ただし、プログラム呼び出しの開始、終了のとき、構文エラー等が起きたときのメッセージは、0を設定していても出力されます。<br>
<br>
<b>・モーダル情報のコメント出力の設定</b><br>
スクリプト内の<br>
<b>$modal_flag= 0;</b><br>
の行で、出力する場合は1、しない場合は0を設定してください。<br>
<br>
<b>・出力したコメントを削除したい場合</b><br>
モーダル情報の行だけを削除したい場合はremove_modal_comment.pl、<br>
原文、内部処理の行も含めて削除したい場合はremove_debug_comment.plを別途使用してください。</p>

<p><h3>[Fコードの小数点の出力について]</h3>
Fコードで指定する数値の小数点以下が0のとき、<br>
<b>$F_flag= 0;</b><br>
の行で、小数点を出力しない場合は0、小数点を出力する場合は1を設定してください。</p>

<p><h3>[オプショナルブロックスキップについて]</h3>
<b>$OBS_switch= 0;</b><br>
の行で、オプショナルブロックスキップを有効(ON)にしたい場合は1、
無効(OFF)にしたい場合は0を設定してください。</p>

<p><h3>[M98の繰り返し数の指定方法について]</h3>
<p>コントローラによって2種類のものがあるようです。<br>
<br>
1. <b>M98P○○○○L○○○○</b>で指令して、L○○○○で繰り返し数を指定する。<br>
2. <b>M98P○○○○○○○○</b>で指令して、○の前半4桁で繰り返し数を指定する。<br>
<br>
<b>$M98_houshiki= 0;</b><br>
の行で、1.の場合は0、2.の場合は1を設定して下さい。</p>

<p><h3>[多重度の制限について]</h3>
マクロ呼び出しなら5回、マクロとサブプログラム呼び出し合わせてなら9回の多重呼び出しでエラーとなり、終了します。</p>

<p><h3>[数値の精度について]</h3>
関数等の演算結果や、変数の中の数値は10進8桁の精度を持ちます。</br>
出力時には小数点3桁まで(小数点第4位を四捨五入)を出力します。</p> 

<p><h3>[シーケンス番号の出力について]</h3>
変換前のブロックにシーケンス番号が付いている場合でも、シーケンス番号は出力されません。</p>

<p><h3>[サンプルデータについて]</h3>
macro_sample.ncd というマクロサンプルを同梱しました。<br>
macro_sample.dxf にイメージ図がありますが、ボルトホールサークルのマクロ例です。<br>
マクロサンプルの中に呼び出し命令、呼び出されるプログラムとも入っているので、<br>
サンプルを入力ファイルに指定するだけで変換されます。